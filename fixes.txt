(1) `nixos-rebuild switch` your system without xserver enabled so it works okay

(2) enable xserver in your configuration, and build the system:

nix-build -A system '<nixpkgs/nixos>' --out-link "./system-with-xserver"

(3) build the install media:

nix-build -A system --out-link "./install-media" -I "nixos-config=$(nix-instantiate --eval --strict -E '<nixpkgs/nixos/modules/installer/cd-dvd/installation-cd-minimal.nix>')" "$(nix-instantiate --eval --strict -E '<nixpkgs/nixos/default.nix>')"

(4) `nix-shell -p diffoscope`

diffoscope ./system-with-xserver ./install-media
